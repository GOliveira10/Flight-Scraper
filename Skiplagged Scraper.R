library(rvest)
library(RSelenium)
library(tidyverse)
library(lubridate)
library(reshape2)
library(geosphere)

airport_codes <- read_csv("airport-codes.csv")
base_url <- "https://skiplagged.com/flights"

top_airports <- read_csv("top_airports.csv")

top_airports <- top_airports %>% select(RANK, CODE)
names(top_airports) <- c("rank", "iata_code")

airport_codes <- left_join(airport_codes, top_airports, by = "iata_code")
coordinates <- str_split_fixed(airport_codes$coordinates, ",", n=2) %>% as_tibble()
names(coordinates) <- c("lat", "lon")
coordinates$l <- as.numeric(coordinates$lat)
coordinates$lon <- as.numeric(coordinates$lon)
airport_codes <- bind_cols(airport_codes, coordinates)
airport_codes$iata_code <- ifelse(is.na(airport_codes$iata_code) | airport_codes$iata_code == "0", airport_codes$ident, airport_codes$iata_code)
airport_codes <- airport_codes %>% filter(!is.na(iata_code) & type != "closed")
airport_codes <- airport_codes %>% group_by(iata_code) %>% summarise_all(first)

# 
# test_data <- function(rm=FALSE){
#   
#   if(rm == FALSE){
#   assign("from", "LAX", envir = .GlobalEnv)
#   assign("to", "SEA", envir = .GlobalEnv)
#   assign("depart_wday", NULL, envir = .GlobalEnv)
#   assign("return_wday", NULL, envir = .GlobalEnv)
#   assign("window", 10, envir = .GlobalEnv)
#   assign("window_start", Sys.Date(), envir = .GlobalEnv)
#   assign("leave", NULL, envir = .GlobalEnv)
#   assign("return", NULL, envir = .GlobalEnv)
#   assign("duration", 4, envir = .GlobalEnv)
#   assign("interval", 1, envir = .GlobalEnv)
#   assign("one_way", FALSE, envir = .GlobalEnv)
#   assign("try_alternate_routes", TRUE, envir = .GlobalEnv)
#   assign("row", 1, envir = .GlobalEnv)
#   } else{
#     
#     rm(list=c("from", 
#              "to", 
#              "depart_wday", 
#              "return_wday", 
#              "window", 
#              "window_start",
#              "leave",
#              "return",
#              "duration",
#              "interval",
#              "one_way",
#              "try_alternate_routes",
#              "row"))
#     
#   }
#   
# }




calculate_distance <- function(from, to){
  
  lat_1 <- airport_codes %>% filter(iata_code == from) %>% .$lat %>% as.numeric()
  lon_1 <- airport_codes %>% filter(iata_code == from) %>% .$lon %>% as.numeric()
  
  lat_2 <- airport_codes %>% filter(iata_code == to) %>% .$lat %>% as.numeric()
  lon_2 <- airport_codes %>% filter(iata_code == to) %>% .$lon %>% as.numeric()
  
  
  distance <- distm(c(lon_1, lat_1), c(lon_2, lat_2), fun = distVincentyEllipsoid) %>% as.numeric()
  return(distance)
  
}



create_flight_url <- function(from, to, leave = NULL, return = NULL){
  
  
  if(grepl("[A-Z]{3,4}", from)){
    from_airport <- airport_codes %>% 
      filter(type %in% c("large_airport", "medium_airport")) %>% 
      filter(iata_code == from)
    
  } else{
  
  from_airport <- airport_codes %>% 
    filter(type %in% c("large_airport", "medium_airport")) %>% 
    filter(municipality == from)
  
  }
  
  if(nrow(from_airport) == 0){
  
    from_airport <- airport_codes %>% 
      filter(!type %in% c("large_airport", "medium_airport"))  %>% 
      filter(municipality == from)
    
    if(nrow(from_airport) == 0){
      message("No airports found")
    }
    
  } else if(nrow(from_airport) > 1){
    message("Multiple Airports in Departure City.")
    
    from_options <- from_airport %>% 
      select(type, iata_code) %>% distinct()
    
    print(from_options)
    departure_prompt <- readline(prompt =  "Which one?")
    from_airport <- from_options$iata_code[as.numeric(departure_prompt)]
  } else if(nrow(from_airport) == 1){
    
  from_airport <- from_airport$iata_code[1]
    
  }

if(!is.null(to)){
if(grepl("[A-Z]{3,4}", to)){
    to_airport <- airport_codes %>% 
      filter(type %in% c("large_airport", "medium_airport")) %>% 
      filter(iata_code == to)
    
  } else{
to_airport <- airport_codes %>% 
    filter(type %in% c("large_airport", "medium_airport")) %>% 
    filter(municipality == to)
  }
  
  if(nrow(to_airport) == 0){
    
    to_airport <- airport_codes %>% 
      filter(!type %in% c("large_airport", "medium_airport"))  %>% 
      filter(municipality == to)
    
    if(nrow(to_airport) == 0){
      message("No airports found")
    }
    
  } else if(nrow(to_airport) > 1){
    message("Multiple Airports in Departure City.")
    
    to_options <- to_airport %>% 
      select(type, iata_code) %>% distinct()
    
    print(to_options)
    departure_prompt <- readline(prompt =  "Which one?")
    to_airport <- to_options$iata_code[as.numeric(departure_prompt)]
    
  } else if(nrow(to_airport) == 1){
    
    to_airport <- to_airport$iata_code[1]
    
  }
} else{
  to_airport <- ""
}
  
  if(is.null(leave) & is.null(return)){
  flight_url <- paste(base_url, from_airport, to_airport, sep="/")
  } else{
    flight_url <- paste(base_url, from_airport, to_airport, leave, return, sep="/")
    
  }

  return(flight_url)
  
  
}


extract_elements <- function(x, using = 'xpath'){
  
  data <- list()
  Sys.sleep(1)
  
  extract_trip_from_element <- function(x){
    trip_data <- x$getElementText()
    trip_data <- str_split(trip_data, "\\n", simplify = TRUE) %>% unlist()
    return(trip_data)
  }
  
  using <- 'xpath'
  
  find_elements <- function(x){
    tryCatch(x,
             error = function(c){
               NULL
             })
    
  }
  
  repeat{
  elements <- find_elements(remDr$findElements(using = using, x))
  if(!is.null(elements)){
    elements <- find_elements(remDr$findElements(using = using, x))
    data <- sapply(elements, extract_trip_from_element)
    break
  }        
  }
  
  
return(data)
}





raw_list_to_dataframe <- function(x, leave, return){
  
  # x <- data
  
  
  clear_blanks <- function(x){
    if(length(x) < 3){
      return(NULL)
    } else {
      return(x)
    }
  }
  
  clean_data <- lapply(x, clear_blanks)
  
  clean_data_frame <- tibble()
  for(i in 1:length(x)){
    trip_item <- x[[i]] %>% as.character()
    if(is.null(trip_item)){
      next
    }
    
    row <- tibble(duration = trip_item[grepl("[0-9]{1,2}h", trip_item)],
                  route = paste(trip_item[grepl("[A-Z]{3,4}", trip_item)], collapse = "-"),
                  departure = trip_item[grepl("[0-9]{1,2}:[0-9]{2}[a-z]{2}", trip_item)][1],
                  arrival = trip_item[grepl("[0-9]{1,2}:[0-9]{2}[a-z]{2}", trip_item)][2],
                  price = trip_item[grepl("\\$[0-9]", trip_item)]
                  )
    
    row$duration <- gsub("h", "", row$duration) %>% as.numeric()
    
    clean_data_frame <- bind_rows(clean_data_frame, row)
    
  }


  
  
  

if(nrow(clean_data_frame) != 0){
 # print(clean_data_frame)
  clean_data_frame <- clean_data_frame[complete.cases(clean_data_frame),] 
  
  
  clean_data_frame$price <- as.character(clean_data_frame$price)
  clean_data_frame$price <- as.numeric(gsub("[^0-9.]", "", clean_data_frame$price))
  clean_data_frame$leave <- leave
  clean_data_frame$return <- return
  return(clean_data_frame)
} else{
  return(tibble())  
}

}






explore_prices <- function(from = NULL, 
                           to = NULL, 
                           depart_wday = NULL, 
                           return_wday = NULL, 
                           window = NULL,
                           window_start = Sys.Date(),
                           leave = NULL, 
                           return = NULL, 
                           duration = NULL, 
                           interval = NULL,
                           one_way = FALSE,
                           try_alternate_routes = TRUE){

 
if(!is.Date(window_start)){
  window_start <- as.Date(window_start)
}  
  
if(!isTRUE(mget(x="scraper_environment", ifnotfound = FALSE)$scraper_environment)){
  scraper_environment <- new.env()
}  

if(!is.null(scraper_environment$results)){
  
  scraper_environment$last_run <- scraper_environment$results
  
}



  
  
prepare_data <- function(){  

skiplagged_url <- create_flight_url(from = from, 
                                      to = to)  



# Find trip of x duration within a given window at a given interval  ####
if(is.null(leave) & !is.null(duration) & is.null(depart_wday)){  
  

message("Creating date sequence")

end_date <- window_start + days(window) 

if(is.null(interval)){
  interval <- duration
  message("Defaulting to Trip Duration as Interval")
}


start <- seq.Date(from=window_start, to = end_date, by = interval)
end <- start + days(duration)

dates <- tibble(start, end)
dates$start <- as.character(dates$start)
dates$end <- as.character(dates$end)

skiplagged_url <- paste0(skiplagged_url, "/", dates$start, "/", dates$end)


}

  
# Find prices for a given week segment ####   
if(!is.null(depart_wday) & !is.null(return_wday)){

  # depart_wday <- "1"
  # return_wday <- "7"
  
  init_dates <- seq.Date(from = window_start + days(1), to = window_start + days(14), by = 1)
  
  start <- min(init_dates[which(wday(init_dates) == depart_wday)])
  end <- min(init_dates[which(wday(init_dates) == return_wday & init_dates > start)])
  
  duration <- end - start
  start <- seq.Date(from=start, by = 7, length.out = window)
  end <- seq.Date(from=end, by = 7, length.out = window)
  dates <- tibble(start, end)
  dates$start <- as.character(dates$start)
  dates$end <- as.character(dates$end)
  
  
  skiplagged_url <- paste0(skiplagged_url, "/", dates$start, "/", dates$end)
  
  
  
}  

  


urls <- tibble(url_0 = skiplagged_url,  type = "normal") #url_2 = "", url_3 = "", url_4 = "",



# Construct list of alternate routes from nearby airports ####

if(try_alternate_routes == TRUE){
  

  possible_airports <- airport_codes %>% filter(!is.na(rank) & !iata_code %in% c(to, from)) %>% select(iata_code) %>% unique()

  possible_airports$from_dist <- map(possible_airports$iata_code, function(x) calculate_distance(from = from, to = x)) %>% unlist()
  possible_airports$to_dist <- map(possible_airports$iata_code, function(x) calculate_distance(from = x, to = to)) %>% unlist()
  possible_airports <- possible_airports %>% mutate(avg_dist = (from_dist + to_dist)/2)
  
  possible_airports <- possible_airports %>% 
    mutate(from_rank = rank(from_dist), 
           to_rank = rank(to_dist),
           avg_rank = rank(avg_dist))
  
  possible_airports <- possible_airports %>% filter(from_rank <= 2 | to_rank <= 2 | avg_rank <= 2)
  
  
  url_1 <- map(possible_airports$iata_code, function(x) create_flight_url(from = from, to = x)) %>% unlist()
  url_2 <- map(possible_airports$iata_code, function(x) create_flight_url(from = x, to = to)) %>% unlist()
  url_3 <- map(possible_airports$iata_code, function(x) create_flight_url(from = to, to = x)) %>% unlist()
  url_4 <- map(possible_airports$iata_code, function(x) create_flight_url(from = x, to = from)) %>% unlist()
  type <- "options"
  
  
  url_1 <- paste0(url_1, "/", dates$start, "/")
  url_2 <- paste0(url_2, "/", dates$start, "/")
  url_3 <- paste0(url_3, "/", dates$end, "/")
  url_4 <- paste0(url_4, "/", dates$end, "/")
  
  alternate_options <- tibble(url_1, url_2, url_3, url_4, type)
  urls <- bind_rows(urls, alternate_options)
}




urls <- urls %>% melt(id.vars = "type")

dates <- urls$value %>% str_extract_all("[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}", simplify = TRUE) %>% as_tibble()
names(dates) <- c("start", "end")

urls <- bind_cols(urls, dates)

names(urls) <- c("type", "variable", "url", "start", "end")

urls <- urls %>% filter(url != "")

urls$end <- ifelse(urls$end == "", urls$start, urls$end)

urls$type <- ifelse(urls$variable %in% c("url_3", "url_4"), "return_options", ifelse(urls$variable %in% c("url_1", "url_2"), "depart_options", "normal"))

return(urls)

# End prepare data ####

}


get_flight_data <- function(urls, return_basic_data = FALSE, return_clean_data = FALSE){

  
all_dates <- tibble()  
for(row in 1:nrow(urls)){

# row <- 1

  message(paste0("Crawling url: ", row, " of ", nrow(urls)))
  remDr$navigate(urls$url[row])

  zoomInJS <- "document.body.style.zoom='50%'"
  
  remDr$executeScript(script = zoomInJS)


  
  trip_xpath_A <- '//*[contains(concat( " ", @class, " " ), concat( " ", "no-touch", " " ))]'
  trip_xpath_B <- '//*[contains(concat( " ", @class, " " ), concat( " ", "skip-trip", " " ))]'
  trip_xpath_C <- '//*[contains(concat( " ", @class, " " ), concat( " ", "trip", " " ))]' 
  
  
  trip_paths <- list(trip_xpath_A, trip_xpath_C, trip_xpath_B)
  
  data <- list()
  timeout <- FALSE
  start_time <- Sys.time()

  
# Extract loop ####  
repeat{
  
  Sys.sleep(2)
  
  data <- extract_elements(trip_xpath_C)
  
  if(length(data) > 3){
    break
  }
  
  data <- extract_elements(trip_xpath_B)
  
  if(length(data) > 3){
    break
  }
  
  data <- extract_elements(trip_xpath_A)
  
  if(length(data) > 3){
    break
  }
  

  if(Sys.time() - start_time > 15){
    timeout <- TRUE
    break
  }
  
  if(return_basic_data == TRUE){
    print(data)
  }  
  # print(data)
  remDr$refresh()
  
# End extract loop ####
  
}

  
repeat{
  
  Sys.sleep(.2)

  clean_data <- data %>% raw_list_to_dataframe(leave = urls$start[row], 
                                             return = urls$end[row])

  
  if(return_clean_data == TRUE){
    print(clean_data)
  }  
  


if(nrow(clean_data) > 1){
  clean_data$url <- urls$url[row]
  break
} 

if(Sys.time() - start_time > 15){
  timeout <- TRUE
  break
}
}

if(timeout == TRUE){
  message("Exiting due to page timeout")
  next
}

clean_data$type <- urls$type[row]
  



intended_dest <- gsub("https://skiplagged.com/flights/", "", clean_data$url) 

intended_dest <- str_extract_all(intended_dest, "[A-Z//]*")

intended_dest <- lapply(intended_dest, paste0, collapse = "") %>% unlist()

intended_dest <- gsub("/{2}", "", intended_dest)

intended_dest <- str_split(intended_dest, "/", n = 2, simplify = TRUE) %>% as_tibble()
names(intended_dest) <- c("from", "to")
clean_data <- bind_cols(clean_data, intended_dest)

routes <- str_split(clean_data$route, paste0("(?<=",clean_data$to,")-"))

recombine_routes <- function(x){
  
  trip <- list()
  hidden_leg <- ""
  trip$route <- x[1]
  

  if(length(x) > 1){
    hidden_leg <- paste0(x[2:length(x)], collapse = "-")
  }
  
  trip$hidden_leg <- hidden_leg
  return(trip)
  
}


routes <- lapply(routes, recombine_routes) %>% bind_rows()

clean_data$route <- routes$route
clean_data$hidden_leg <- routes$hidden_leg
clean_data$hidden_city <- ifelse(clean_data$hidden_leg != "", TRUE, FALSE)


all_dates <- bind_rows(all_dates, clean_data)

}


all_dates <- all_dates # %>% arrange(price)

attr(all_dates, which = "trip") <- paste0(from, "-", to)
#attr(all_dates, which = "window") <- paste0(as.character(wday(start, label = TRUE)), " to ", as.character(wday(end, label = TRUE)))
attr(all_dates, which = "duration") <- paste0("Trip Duration: ", duration, " Days")

all_dates$number_of_stops <- str_count(all_dates$route, "-")

scraper_environment$results <- all_dates

return(all_dates)

}


urls <- prepare_data()

all_dates <- get_flight_data(urls)

return(all_dates)

}



construct_options <- function(x, depart_city, arrival_city, which_options){
  
  #x <- options 
  
  
  depart_options <- x %>% filter(type == which_options)
  
  depart_options <- depart_options %>% 
    mutate(departure_time = as.POSIXct(paste0(leave, " ", departure))) %>%
    mutate(arrival_time = departure_time + hours(as.numeric(gsub("h", "", duration))))
  
  first_leg <- depart_options %>% filter(from == depart_city)
  second_leg <- depart_options %>% filter(to == arrival_city)
  
  trips <- full_join(first_leg, second_leg, by = c("to" = "from"))
  
  possible_trips <- trips %>% filter(arrival_time.x < departure_time.y)
  
  possible_trips <- possible_trips %>% mutate(price = price.x + price.y,
                                              route = paste0(route.x, route.y, collapse = "-"),
                                              duration =  duration.x + duration.y)
  
  
  
  
  
  
  summary <- possible_trips %>% group_by(leave.x) %>% summarize(min_price = min(price),
                                                                min_duration = min(duration))
  
  
  
  names_possible <- names(possible_trips)
  names_summary <- names(summary)  
  
  if(which_options == "depart_options"){
    
    
    names_possible <- gsub("\\.x", "_departure_one_way", names_possible)
    names_summary <- gsub("\\.x", "_departure_one_way", names_summary)
    
  } else{
    
    names_possible <- gsub("\\.x", "_arrival_one_way", names_possible)
    names_summary <- gsub("\\.x", "_arrival_one_way", names_summary)
  }
  
  names(possible_trips) <- names_possible
  names(summary) <- names_summary
  
  result <- list(possible_trips,
                 summary)
  
  return(result)
}


# airlines_xpath <- '//*[contains(concat( " ", @class, " " ), concat( " ", "airlines-lg", " " ))]'

# extract_elements('//*span//[contains(concat( " ", @class, " " ), concat( " ", "airlines-lg", " " ))]', "xpath")







